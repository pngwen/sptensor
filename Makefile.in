CFLAGS=-I./include -g @CFLAGS@
LDFLAGS=-L./build/lib @LDFLAGS@
LIBS=-lsptensor @LIBS@
CC=@CC@
LD=@CC@


SPTENSOR_LIB_SRCFILES := lib/index.c \
                         lib/vector.c \
                         lib/index_iterator.c\
						 lib/coo.c\
						 lib/sptensor.c\
						 lib/inzt.c\
						 lib/skbt.c\
						 lib/math.c\
						 lib/transform.c\
						 lib/hash.c\
						 lib/constant.c\
						 lib/identity.c

SPTENSOR_LIB_OBJFILES := $(patsubst lib/%.c, ./build/obj/%.o, $(SPTENSOR_LIB_SRCFILES))

SPTENSOR_LIB_TARGETS := build/lib/libsptensor.so \
                        build/lib/libsptensor.a

SPTENSOR_TEST_SRCFILES := test/indextest.c\
	                      test/coo-test.c\
						  test/inzt-test.c\
						  test/morton-test.c\
						  test/skbttest.c\
						  test/math-test.c\
						  test/coo-io-test.c\
						  test/coo-print-test.c\
						  test/hash-test.c\
						  test/hash-io-test.c\
						  test/constant-test.c\
						  test/transform-test.c

SPTENSOR_TEST_TARGETS := $(patsubst test/%.c,  build/test/%, $(SPTENSOR_TEST_SRCFILES))


all: dirs $(SPTENSOR_LIB_TARGETS) $(SPTENSOR_TEST_TARGETS)
dirs: build/lib/ build/bin/ build/obj/ build/test/
build/%/:
	mkdir -p $@

#Library Builds
build/lib/libsptensor.so: $(SPTENSOR_LIB_OBJFILES)
	$(CC) -o $@ $(CFLAGS) -fPIC $^ -shared
build/lib/libsptensor.a: $(SPTENSOR_LIB_OBJFILES)
	ar crf build/lib/libsptensor.a $^

#Object Builds
build/obj/%.o: lib/%.c 
	$(CC) -o $@ -c $< $(CFLAGS) -fPIC

#Test Builds
build/test/%: test/%.c $(SPTENSOR_LIB_OBJFILES)
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS) -static $(LIBS)


.PHONY: clean 
clean:
	rm -rf *.o build $(SPTENSOR_LIB_TARGETS)
